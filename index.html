<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MC Wildchat</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  
  <!-- PeerJS for WebRTC -->
  <script src="https://unpkg.com/peerjs@1.5.0/dist/peerjs.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDvT_GPef-lLPD2X86xM2MLSTl7s7OQfKg",
        authDomain: "chat-together-mc.firebaseapp.com",
        databaseURL: "https://chat-together-mc-default-rtdb.firebaseio.com",
        projectId: "chat-together-mc",
        storageBucket: "chat-together-mc.firebasestorage.app",
        messagingSenderId: "647441407343",
        appId: "1:647441407343:web:b76cf33d52fc01b8631c9a",
        measurementId: "G-07E1B315VT"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const database = firebase.database();

    // Icons
    const Users = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
      </svg>
    );

    const MessageCircle = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
      </svg>
    );

    const Clock = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );

    const LogOut = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
      </svg>
    );

    const Refresh = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
    );

    const Video = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
      </svg>
    );

    const VideoOff = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
      </svg>
    );

    const Mic = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
      </svg>
    );

    const MicOff = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
      </svg>
    );

    function AnonymousMatcher() {
      const [status, setStatus] = useState('disconnected');
      const [userId, setUserId] = useState(null);
      const [sessionId, setSessionId] = useState(null);
      const [messages, setMessages] = useState([]);
      const [messageInput, setMessageInput] = useState('');
      const [waitingCount, setWaitingCount] = useState(0);
      const [error, setError] = useState(null);
      const [partnerDisconnected, setPartnerDisconnected] = useState(false);
      const [isVideoActive, setIsVideoActive] = useState(false);
      const [isMuted, setIsMuted] = useState(false);
      const [isVideoMuted, setIsVideoMuted] = useState(false);
      const [remoteStreamActive, setRemoteStreamActive] = useState(false);
      
      const messagesEndRef = useRef(null);
      const listenerRef = useRef(null);
      const sessionListenerRef = useRef(null);
      const hasAddedDisconnectMessage = useRef(false);
      const localVideoRef = useRef(null);
      const remoteVideoRef = useRef(null);
      const peerRef = useRef(null);
      const localStreamRef = useRef(null);
      const callRef = useRef(null);
      const peerIdListenerRef = useRef(null);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      // Cleanup on unmount
      useEffect(() => {
        return () => {
          if (listenerRef.current) {
            listenerRef.current();
          }
          if (sessionListenerRef.current) {
            sessionListenerRef.current();
          }
          if (peerIdListenerRef.current) {
            peerIdListenerRef.current();
          }
          stopVideo();
        };
      }, []);

      const generateUserId = () => {
        return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      };

      const joinQueue = async () => {
        try {
          setError(null);
          setPartnerDisconnected(false);
          hasAddedDisconnectMessage.current = false;
          setMessages([]);
          const newUserId = generateUserId();
          setUserId(newUserId);
          console.log('My User ID:', newUserId);

          await database.ref(`waiting/${newUserId}`).set({
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            status: 'waiting'
          });
          console.log('Added to waiting pool');

          setStatus('waiting');
          
          listenForMatch(newUserId);
          
          setTimeout(() => {
            attemptMatching(newUserId);
          }, 500);
        } catch (err) {
          setError('Failed to join queue. Please try again.');
          console.error('Join queue error:', err);
        }
      };

      const listenForMatch = (currentUserId) => {
        console.log('Setting up match listener for:', currentUserId);
        const sessionsRef = database.ref('sessions');
        const listener = sessionsRef.on('child_added', (snapshot) => {
          const session = snapshot.val();
          const sid = snapshot.key;
          console.log('Session created:', sid, session);
          
          if (session.user1 === currentUserId || session.user2 === currentUserId) {
            console.log('I am in this session! Moving to matched state');
            setSessionId(sid);
            setStatus('matched');
            setPartnerDisconnected(false);
            hasAddedDisconnectMessage.current = false;
            sessionsRef.off('child_added', listener);
            listenForMessages(sid);
            initializePeer(currentUserId, sid);
          } else {
            console.log('This session is not for me');
          }
        });

        listenerRef.current = () => sessionsRef.off('child_added', listener);
      };

      const initializePeer = (currentUserId, sid) => {
        console.log('Initializing peer for user:', currentUserId);
        
        if (peerRef.current) {
          peerRef.current.destroy();
        }

        // Create peer with random ID
        peerRef.current = new Peer();

        peerRef.current.on('open', (peerId) => {
          console.log('My peer ID is:', peerId);
          
          // Store peer ID in Firebase under this user's ID
          database.ref(`sessions/${sid}/peers/${currentUserId}`).set(peerId);

          // Listen for partner's peer ID
          const peersRef = database.ref(`sessions/${sid}/peers`);
          const peerListener = peersRef.on('value', (snapshot) => {
            const peers = snapshot.val() || {};
            console.log('All peers:', peers);
            
            // Find partner's peer ID (not mine)
            const partnerUserId = Object.keys(peers).find(uid => uid !== currentUserId);
            
            if (partnerUserId) {
              const partnerPeerId = peers[partnerUserId];
              console.log('Partner peer ID found:', partnerPeerId);
              
              // If we have a local stream, initiate call
              if (localStreamRef.current && !callRef.current) {
                console.log('Calling partner with peer ID:', partnerPeerId);
                makeCall(partnerPeerId);
              }
            }
          });
          
          peerIdListenerRef.current = () => peersRef.off('value', peerListener);
        });

        // Handle incoming calls
        peerRef.current.on('call', (call) => {
          console.log('Receiving incoming call');
          
          if (localStreamRef.current) {
            console.log('Answering call with local stream');
            call.answer(localStreamRef.current);
            callRef.current = call;
            
            call.on('stream', (remoteStream) => {
              console.log('Received remote stream on incoming call');
              if (remoteVideoRef.current) {
                remoteVideoRef.current.srcObject = remoteStream;
                setRemoteStreamActive(true);
              }
            });

            call.on('close', () => {
              console.log('Call closed');
              setRemoteStreamActive(false);
            });
          } else {
            console.log('No local stream to answer with');
          }
        });

        peerRef.current.on('error', (err) => {
          console.error('Peer error:', err);
          setError('Connection error: ' + err.type);
        });
      };

      const makeCall = (partnerPeerId) => {
        if (!peerRef.current || !localStreamRef.current) {
          console.log('Cannot make call - missing peer or stream');
          return;
        }

        console.log('Making call to:', partnerPeerId);
        const call = peerRef.current.call(partnerPeerId, localStreamRef.current);
        callRef.current = call;
        
        call.on('stream', (remoteStream) => {
          console.log('Received remote stream on outgoing call');
          if (remoteVideoRef.current) {
            remoteVideoRef.current.srcObject = remoteStream;
            setRemoteStreamActive(true);
          }
        });

        call.on('close', () => {
          console.log('Call closed');
          setRemoteStreamActive(false);
        });

        call.on('error', (err) => {
          console.error('Call error:', err);
        });
      };

      const startVideo = async () => {
        try {
          console.log('Starting video...');
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: true, 
            audio: true 
          });
          
          console.log('Got local stream');
          localStreamRef.current = stream;
          if (localVideoRef.current) {
            localVideoRef.current.srcObject = stream;
          }
          
          setIsVideoActive(true);

          // Check if partner's peer ID is already available
          if (sessionId && userId) {
            const snapshot = await database.ref(`sessions/${sessionId}/peers`).once('value');
            const peers = snapshot.val() || {};
            console.log('Existing peers:', peers);
            
            const partnerUserId = Object.keys(peers).find(uid => uid !== userId);
            
            if (partnerUserId) {
              const partnerPeerId = peers[partnerUserId];
              console.log('Partner already connected, calling:', partnerPeerId);
              makeCall(partnerPeerId);
            } else {
              console.log('Waiting for partner to join...');
            }
          }
        } catch (err) {
          console.error('Error accessing camera/microphone:', err);
          setError('Could not access camera/microphone. Please check permissions.');
        }
      };

      const stopVideo = () => {
        console.log('Stopping video');
        
        if (localStreamRef.current) {
          localStreamRef.current.getTracks().forEach(track => track.stop());
          localStreamRef.current = null;
        }
        
        if (callRef.current) {
          callRef.current.close();
          callRef.current = null;
        }
        
        if (peerIdListenerRef.current) {
          peerIdListenerRef.current();
          peerIdListenerRef.current = null;
        }
        
        if (localVideoRef.current) {
          localVideoRef.current.srcObject = null;
        }
        if (remoteVideoRef.current) {
          remoteVideoRef.current.srcObject = null;
        }
        
        setIsVideoActive(false);
        setRemoteStreamActive(false);
      };

      const toggleMute = () => {
        if (localStreamRef.current) {
          const audioTrack = localStreamRef.current.getAudioTracks()[0];
          if (audioTrack) {
            audioTrack.enabled = !audioTrack.enabled;
            setIsMuted(!audioTrack.enabled);
          }
        }
      };

      const toggleVideo = () => {
        if (localStreamRef.current) {
          const videoTrack = localStreamRef.current.getVideoTracks()[0];
          if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            setIsVideoMuted(!videoTrack.enabled);
          }
        }
      };

      const attemptMatching = async (currentUserId) => {
        try {
          console.log('Attempting to match for:', currentUserId);
          const waitingSnapshot = await database.ref('waiting').once('value');
          const waiting = waitingSnapshot.val() || {};
          console.log('Users in waiting pool:', Object.keys(waiting));
          
          const otherUsers = Object.keys(waiting).filter(id => id !== currentUserId);
          console.log('Other users available:', otherUsers);
          
          if (otherUsers.length > 0) {
            const partnerId = otherUsers[0];
            const newSessionId = database.ref('sessions').push().key;
            console.log('Creating session:', newSessionId, 'between', currentUserId, 'and', partnerId);
            
            const session = {
              user1: currentUserId,
              user2: partnerId,
              createdAt: firebase.database.ServerValue.TIMESTAMP,
              messages: {},
              peers: {}
            };

            await Promise.all([
              database.ref(`sessions/${newSessionId}`).set(session),
              database.ref(`waiting/${currentUserId}`).remove(),
              database.ref(`waiting/${partnerId}`).remove()
            ]);
            console.log('Session created and users removed from waiting');
          } else {
            console.log('No other users to match with');
            updateWaitingCount();
          }
        } catch (err) {
          console.error('Matching error:', err);
        }
      };

      const updateWaitingCount = async () => {
        try {
          const snapshot = await database.ref('waiting').once('value');
          const waiting = snapshot.val() || {};
          setWaitingCount(Object.keys(waiting).length);
        } catch (err) {
          console.error('Count error:', err);
        }
      };

      const listenForMessages = (sid) => {
        const messagesRef = database.ref(`sessions/${sid}/messages`);
        const listener = messagesRef.on('value', (snapshot) => {
          const messagesData = snapshot.val() || {};
          const messagesList = Object.entries(messagesData).map(([id, msg]) => ({
            id,
            ...msg
          })).sort((a, b) => a.timestamp - b.timestamp);
          setMessages(messagesList);
        });

        const sessionRef = database.ref(`sessions/${sid}`);
        const sessionListener = sessionRef.on('value', (snapshot) => {
          if (!snapshot.exists()) {
            console.log('Session deleted - partner disconnected');
            if (!hasAddedDisconnectMessage.current) {
              hasAddedDisconnectMessage.current = true;
              setMessages(prev => [...prev, {
                id: 'disconnect_' + Date.now(),
                sender: 'system',
                text: 'Wildcat has disconnected',
                timestamp: Date.now()
              }]);
              setPartnerDisconnected(true);
              stopVideo();
            }
          }
        });

        listenerRef.current = () => messagesRef.off('value', listener);
        sessionListenerRef.current = () => sessionRef.off('value', sessionListener);
      };

      const sendMessage = async () => {
        if (!messageInput.trim() || !sessionId || partnerDisconnected) return;

        try {
          const newMessageRef = database.ref(`sessions/${sessionId}/messages`).push();
          await newMessageRef.set({
            sender: userId,
            text: messageInput,
            timestamp: firebase.database.ServerValue.TIMESTAMP
          });
          
          setMessageInput('');
        } catch (err) {
          setError('Failed to send message. Please try again.');
          console.error('Send message error:', err);
        }
      };

      const leaveSession = async () => {
        try {
          stopVideo();
          
          if (listenerRef.current) {
            listenerRef.current();
          }
          if (sessionListenerRef.current) {
            sessionListenerRef.current();
          }
          if (peerIdListenerRef.current) {
            peerIdListenerRef.current();
          }
          if (peerRef.current) {
            peerRef.current.destroy();
            peerRef.current = null;
          }

          if (status === 'waiting' && userId) {
            await database.ref(`waiting/${userId}`).remove();
          }
          
          if (status === 'matched' && sessionId && !partnerDisconnected) {
            await database.ref(`sessions/${sessionId}/messages`).push({
              sender: 'system',
              text: 'Wildcat has disconnected',
              timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            setTimeout(async () => {
              await database.ref(`sessions/${sessionId}`).remove();
            }, 500);
          }
          
          setStatus('disconnected');
          setUserId(null);
          setSessionId(null);
          setError(null);
        } catch (err) {
          console.error('Leave session error:', err);
        }
      };

      const matchAgain = async () => {
        await leaveSession();
        setTimeout(() => {
          joinQueue();
        }, 500);
      };

      useEffect(() => {
        if (status === 'waiting') {
          const interval = setInterval(updateWaitingCount, 3000);
          return () => clearInterval(interval);
        }
      }, [status]);

      return (
        <div className="min-h-screen bg-white">
          {/* Header */}
          <div className="bg-blue-900 shadow-md">
            <div className="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="bg-white rounded-lg p-2">
                  <img src="auth/mclogo.png" alt="MC Logo" className="w-6 h-6 object-contain" />
                </div>
                <div>
                  <h1 className="text-2xl font-bold text-white">MC Wildchat</h1>
                  <p className="text-blue-200 text-sm">Do your homework.</p>
                </div>
              </div>
              {status !== 'disconnected' && (
                <button
                  onClick={partnerDisconnected ? matchAgain : leaveSession}
                  className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors font-semibold ${
                    partnerDisconnected 
                      ? 'bg-blue-300 text-blue-900 hover:bg-blue-200' 
                      : 'bg-white text-blue-900 hover:bg-blue-50'
                  }`}
                >
                  {partnerDisconnected ? (
                    <>
                      <Refresh className="w-4 h-4" />
                      Match Again
                    </>
                  ) : (
                    <>
                      <LogOut className="w-4 h-4" />
                      Disconnect
                    </>
                  )}
                </button>
              )}
            </div>
          </div>

          {error && (
            <div className="max-w-6xl mx-auto px-4 mt-4">
              <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                {error}
              </div>
            </div>
          )}

          {/* Main Content */}
          <div className="max-w-6xl mx-auto px-4 py-6">
            {status === 'disconnected' && (
              <div className="text-center py-16">
                <div className="mb-8">
                  <div className="inline-block bg-blue-50 rounded-full p-6 mb-4">
                    <img src="auth/mclogo.png" alt="MC Logo" className="w-16 h-16 object-contain" />
                  </div>
                  <h2 className="text-3xl font-bold text-gray-800 mb-2">MC Wildchat</h2>
                  <p className="text-gray-600 text-lg">"Nothing beside remains"</p>
                </div>
                
                <button
                  onClick={joinQueue}
                  className="px-12 py-4 bg-blue-900 text-white text-xl rounded-lg hover:bg-blue-800 transition-colors font-bold shadow-lg"
                >
                  Start Chatting
                </button>
                
                <div className="mt-8 text-gray-500 text-sm">
                  <p>Click "Start Chatting" to be matched with a random wildcat!</p>
                </div>
              </div>
            )}

            {status === 'waiting' && (
              <div className="text-center py-16">
                <div className="mb-6">
                  <Clock className="w-20 h-20 text-blue-900 mx-auto mb-4 animate-pulse" />
                </div>
                <h2 className="text-2xl font-semibold text-gray-800 mb-2">Looking for a wildcat...</h2>
                <p className="text-gray-600">
                  {waitingCount > 1 ? `${waitingCount} users online` : 'Waiting for someone to connect'}
                </p>
                <div className="mt-8">
                  <div className="inline-block">
                    <div className="flex gap-2">
                      <div className="w-3 h-3 bg-blue-900 rounded-full animate-bounce" style={{animationDelay: '0s'}}></div>
                      <div className="w-3 h-3 bg-blue-900 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                      <div className="w-3 h-3 bg-blue-900 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {status === 'matched' && (
              <div>
                <div className={`border-l-4 p-4 mb-6 ${
                  partnerDisconnected 
                    ? 'bg-gray-50 border-gray-400' 
                    : 'bg-green-50 border-green-500'
                }`}>
                  <div className="flex items-center gap-2">
                    <div className={`w-3 h-3 rounded-full ${
                      partnerDisconnected 
                        ? 'bg-gray-400' 
                        : 'bg-green-500 animate-pulse'
                    }`}></div>
                    <span className={`font-semibold ${
                      partnerDisconnected 
                        ? 'text-gray-600' 
                        : 'text-green-700'
                    }`}>
                      {partnerDisconnected 
                        ? 'Wildcat has left the chat' 
                        : "You're now chatting with another wildcat"}
                    </span>
                  </div>
                </div>

                {/* Video Section */}
                {isVideoActive && (
                  <div className="mb-6">
                    <div className="grid grid-cols-2 gap-4">
                      <div className="relative bg-gray-900 rounded-lg overflow-hidden aspect-video">
                        <video 
                          ref={remoteVideoRef} 
                          autoPlay 
                          playsInline
                          className="w-full h-full object-cover"
                        />
                        {!remoteStreamActive && (
                          <div className="absolute inset-0 flex items-center justify-center bg-gray-800 text-white">
                            <div className="text-center">
                              <Video className="w-12 h-12 mx-auto mb-2 opacity-50" />
                              <p className="text-sm">Waiting for partner...</p>
                            </div>
                          </div>
                        )}
                        <div className="absolute bottom-2 left-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-sm">
                          Wildcat
                        </div>
                      </div>
                      <div className="relative bg-gray-900 rounded-lg overflow-hidden aspect-video">
                        <video 
                          ref={localVideoRef} 
                          autoPlay 
                          muted 
                          playsInline
                          className="w-full h-full object-cover"
                        />
                        <div className="absolute bottom-2 left-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-sm">
                          You
                        </div>
                      </div>
                    </div>
                    
                    {/* Video Controls */}
                    <div className="flex justify-center gap-3 mt-4">
                      <button
                        onClick={toggleMute}
                        className={`p-3 rounded-full transition-colors ${
                          isMuted ? 'bg-red-500 hover:bg-red-600' : 'bg-gray-700 hover:bg-gray-800'
                        } text-white`}
                        title={isMuted ? 'Unmute' : 'Mute'}
                      >
                        {isMuted ? <MicOff className="w-5 h-5" /> : <Mic className="w-5 h-5" />}
                      </button>
                      <button
                        onClick={toggleVideo}
                        className={`p-3 rounded-full transition-colors ${
                          isVideoMuted ? 'bg-red-500 hover:bg-red-600' : 'bg-gray-700 hover:bg-gray-800'
                        } text-white`}
                        title={isVideoMuted ? 'Turn on camera' : 'Turn off camera'}
                      >
                        {isVideoMuted ? <VideoOff className="w-5 h-5" /> : <Video className="w-5 h-5" />}
                      </button>
                      <button
                        onClick={stopVideo}
                        className="p-3 rounded-full bg-red-500 hover:bg-red-600 text-white"
                        title="End call"
                      >
                        End Call
                      </button>
                    </div>
                  </div>
                )}

                {/* Video Button */}
                {!isVideoActive && !partnerDisconnected && (
                  <div className="mb-6 text-center">
                    <button
                      onClick={startVideo}
                      className="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold mx-auto"
                    >
                      <Video className="w-5 h-5" />
                      Start Video Chat
                    </button>
                  </div>
                )}

                {/* Chat Box */}
                <div className="border-2 border-gray-300 rounded-lg overflow-hidden bg-white">
                  {/* Messages Area */}
                  <div className="h-96 overflow-y-auto p-4 bg-gray-50">
                    {messages.length === 0 ? (
                      <div className="text-center text-gray-400 py-12">
                        <MessageCircle className="w-12 h-12 mx-auto mb-2 opacity-50" />
                        <p>Say hi to start the conversation!</p>
                      </div>
                    ) : (
                      <div className="space-y-2">
                        {messages.map((msg) => (
                          <div key={msg.id} className="text-sm">
                            {msg.sender === 'system' ? (
                              <div className="text-center text-gray-500 italic py-2">
                                {msg.text}
                              </div>
                            ) : (
                              <>
                                <span className={`font-bold ${msg.sender === userId ? 'text-blue-900' : 'text-red-600'}`}>
                                  {msg.sender === userId ? 'You' : 'Wildcat'}:
                                </span>
                                <span className="text-gray-800 ml-2">{msg.text}</span>
                              </>
                            )}
                          </div>
                        ))}
                        <div ref={messagesEndRef} />
                      </div>
                    )}
                  </div>

                  {/* Input Area */}
                  <div className="border-t-2 border-gray-300 bg-white p-4">
                    <div className="flex gap-2">
                      <input
                        type="text"
                        value={messageInput}
                        onChange={(e) => setMessageInput(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                        placeholder={partnerDisconnected ? "Partner disconnected..." : "Type your message here..."}
                        disabled={partnerDisconnected}
                        className={`flex-1 px-4 py-3 border-2 border-gray-300 rounded focus:outline-none focus:border-blue-900 text-base ${
                          partnerDisconnected ? 'bg-gray-100 cursor-not-allowed' : ''
                        }`}
                      />
                      <button
                        onClick={sendMessage}
                        disabled={partnerDisconnected}
                        className={`px-8 py-3 rounded font-semibold transition-colors ${
                          partnerDisconnected 
                            ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                            : 'bg-blue-900 text-white hover:bg-blue-800'
                        }`}
                      >
                        Send
                      </button>
                    </div>
                  </div>
                </div>

                {/* Bottom Info */}
                <div className="mt-4 text-center text-gray-500 text-sm">
                  <p>
                    {partnerDisconnected 
                      ? 'Click "Match Again" to find a new wildcat' 
                      : 'Click "Disconnect" to end this chat and find a new wildcat'}
                  </p>
                </div>
              </div>
            )}
          </div>

          {/* Footer */}
          <div className="max-w-6xl mx-auto px-4 py-8 text-center text-gray-400 text-xs">
            <p>MC Wildchat â€¢ Chatting for Marin Catholic students</p>
            <p className="mt-2">Your chats are anonymous and temporary</p>
          </div>
        </div>
      );
    }

    ReactDOM.render(<AnonymousMatcher />, document.getElementById('root'));
  </script>
</body>
</html>